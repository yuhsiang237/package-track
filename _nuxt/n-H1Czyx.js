import{r as i,p as P,c as v,o as c,b as d,w as A,a as n,t as _,q as Y,F as V,d as D,Q as ee,j as te,s as B,k as ne,v as le,x as N,y as ae,z as oe,m as se,n as T,A as ie,B as re}from"#entry";import{s as de,V as L,_ as ue,a as J,b as ce,A as ve,c as pe,g as ge,H as fe,L as me,U as ye}from"./CpiH5u6D.js";import{D as ke}from"./yMyOA5NV.js";import{toPrettyJSONString as j,daysAgo as he,downloadUserData as Ve,formatTextareaJson as we,handlePackageJsonUpload as be}from"./DyUIkCtQ.js";import{getPackageItemData as M,setPackageItemData as xe,getUserPackageData as R,setUserPackageData as E}from"./oisnR8aH.js";import{DEFAULT_USER_PACKAGE_DATA as _e}from"./CaeiBUsO.js";import{updateWidth as S}from"./BFO1sARF.js";const De={class:"info-container"},Ue={class:"title-section"},$e={class:"version-section"},Ce={class:"serial"},Se={class:"version-old"},Pe={class:"serial"},Ae={class:"time"},I=22,Oe={__name:"PackageCard",props:{npmlink:{type:String,default:""},repolink:{type:String,default:""},isUpdateHighlight:{type:Boolean,default:!0},title:{type:String,default:""},currentVersion:{type:String,default:"-"},oldVersion:{type:String,default:"-"},timeAgo:{type:String,default:"-"}},emits:["click"],setup(p){const a=p,o=i(`Package Name: ${a.title}<br/>New Version: ${a.currentVersion}<br/>Current Version: ${a.oldVersion}<br/>${a.timeAgo}`),f=P(()=>de.gt(a.currentVersion||"0.0.0",a.oldVersion||"0.0.0")),w=P(()=>a.title?a.title.length>I?a.title.slice(0,I)+"…":a.title:""),m=g=>{ee.showContextMenu({x:g.x,y:g.y,items:[{label:"Go NPM",onClick:()=>window.open(a.npmlink,"_blank")},{label:"Go Repo",onClick:()=>window.open(a.repolink,"_blank")},{label:"Go Release",onClick:()=>window.open(`${a.repolink}/releases`,"_blank")}]})};return(g,u)=>{const k=L;return c(),v("div",{class:"package-card",onClick:u[0]||(u[0]=y=>m(y))},[d(k,{title:o.value,trigger:"hover"},{default:A(()=>[n("div",De,[n("div",Ue,_(w.value),1),n("div",$e,[n("div",{class:Y(["version-current",{active:p.isUpdateHighlight&&f.value}])},[u[1]||(u[1]=n("svg",{width:"5",height:"6",viewBox:"0 0 5 6",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[n("ellipse",{cx:"2.72362",cy:"3.26668",rx:"2.13158",ry:"2.31111",fill:"#D07D09"})],-1)),n("div",Ce,[p.currentVersion?(c(),v(V,{key:0},[D(_(p.currentVersion),1)],64)):(c(),v(V,{key:1},[D("-")],64))])],2),n("div",Se,[u[2]||(u[2]=n("svg",{width:"5",height:"6",viewBox:"0 0 5 6",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[n("path",{d:"M2.72388 1.16113C3.74428 1.16128 4.60474 2.06501 4.60474 3.22266C4.60453 4.3801 3.74416 5.28305 2.72388 5.2832C1.70348 5.2832 0.842245 4.3802 0.842041 3.22266C0.842041 2.06492 1.70336 1.16113 2.72388 1.16113Z",stroke:"#E3AC40","stroke-width":"0.5"})],-1)),n("div",Pe,[p.oldVersion?(c(),v(V,{key:0},[D(_(p.oldVersion),1)],64)):(c(),v(V,{key:1},[D("-")],64))])])])]),n("div",Ae,_(p.timeAgo),1)]),_:1},8,["title"])])}}},Be={class:"dashboard"},Ne={style:{display:"flex"}},Te={style:{display:"flex","align-items":"end"}},Je={class:"card-action"},je={key:1,class:"card-container",style:{"min-height":"300px",display:"flex","text-align":"center","justify-content":"center","align-items":"center"}},Me={class:"modal-wrapper"},Re={class:"action-bar"},Ee={class:"content"},Ie={class:"bottom-bar"},Ke=te({__name:"index",setup(p){const a=i(_e),o=i(JSON.stringify(B(a.value),null,2)),f=i(!1),w=i([]),m=i(""),g=i("30"),u=i(!1),k=i(!0),y=i(!1),b=i(0),x=i(null),O=i(null),H=P(()=>w.value.filter(l=>{const e=!m.value||l.title.includes(m.value),t=!u.value||Number(l.timeAgo)<=Number(g.value);return e&&t}));ne(()=>{G(),C(),$(Object.keys(a.value))}),le(()=>{W()});function U(l){const e=R();if(e)try{return JSON.parse(e)[l]||null}catch(t){return console.error("解析用戶套件資料失敗:",t),null}return null}async function z(l){const e=new Date().toISOString().split("T")[0];let r=M().find(s=>{if(s.title===l)return console.log(`${s.title}=== ${l} && ${s.fetchDate} === ${e}`),s.title===l&&s.fetchDate===e});if(r)return console.log(`使用快取資料: ${l}`),r.oldVersion=U(l)||"",r;try{const s=await ge(l);return{title:s.name,currentVersion:s.latestVersion,oldVersion:U(l)||"",timeAgo:`${he(s.releaseDate)}`,fetchDate:e,repo:s.repo}}catch{return{title:l,currentVersion:"",oldVersion:U(l)||"",timeAgo:"-",fetchDate:"0001-01-01",repo:""}}}async function $(l){try{f.value=!0;const t=(await Promise.all(l.map(h=>z(h)))).filter(h=>h!==null);w.value=t;const s=[...B(t),...M()].filter((h,Q,Z)=>Z.findIndex(X=>X.title===h.title)===Q);xe(s)}catch(e){console.error("批量取得套件資訊失敗:",e)}finally{f.value=!1}}function C(){const l=R();if(l)try{a.value=JSON.parse(l)}catch(e){console.error("解析用戶套件資料失敗:",e)}else{const e=j(o.value);e&&(o.value=e,E(e)),C(),$(Object.keys(a.value))}o.value=JSON.stringify(a.value,null,2)}function F(){const l=j(o.value);l&&(o.value=l,E(l)),C(),$(Object.keys(a.value)),y.value=!1}function G(){S(b,x),window.addEventListener("resize",()=>S(b,x))}function W(){window.removeEventListener("resize",()=>S(b,x))}function q(){O.value?.click()}async function K(l){const e=l.target,t=e.files?.[0];if(t){try{const r=await be(t);r?(o.value=JSON.stringify(r,null,2),console.log("✅ 成功匯入 package.json 檔案")):console.warn("⚠️ 無法解析 package.json 檔案")}catch(r){console.error("❌ 處理檔案上傳失敗:",r)}e.value=""}}return(l,e)=>(c(),v("div",Be,[n("div",{class:"card-bar",style:ae({width:b.value+"px"})},[n("div",null,[d(ue,{modelValue:m.value,"onUpdate:modelValue":e[0]||(e[0]=t=>m.value=t),placeholder:"關鍵字過濾"},null,8,["modelValue"])]),n("div",Ne,[d(J,{label:"",modelValue:k.value,"onUpdate:modelValue":e[1]||(e[1]=t=>k.value=t)},null,8,["modelValue"]),e[9]||(e[9]=n("label",null," 標記新版可升級",-1))]),n("div",Te,[d(J,{label:"",modelValue:u.value,"onUpdate:modelValue":e[2]||(e[2]=t=>u.value=t)},null,8,["modelValue"]),e[10]||(e[10]=n("label",null," 僅顯示近    ",-1)),d(ce,{modelValue:g.value,"onUpdate:modelValue":e[3]||(e[3]=t=>g.value=t),options:[{label:"7",value:"7"},{label:"14",value:"14"},{label:"30",value:"30"},{label:"45",value:"45"},{label:"90",value:"90"}]},null,8,["modelValue"]),e[11]||(e[11]=n("label",null,"    天更新的套件",-1))])],4),f.value?N("",!0):(c(),v("div",{key:0,class:"card-container",ref_key:"containerRef",ref:x},[(c(!0),v(V,null,oe(H.value,(t,r)=>(c(),se(Oe,{key:r,title:t.title,currentVersion:t.currentVersion,oldVersion:t.oldVersion,timeAgo:`${t.timeAgo} days ago`,isUpdateHighlight:k.value,npmlink:`https://www.npmjs.com/package/${t.title}`,repolink:t.repo},null,8,["title","currentVersion","oldVersion","timeAgo","isUpdateHighlight","npmlink","repolink"]))),128)),n("div",Je,[n("div",null,[d(ve,{onClick:e[4]||(e[4]=t=>y.value=!0)})]),n("div",null,[d(L,{title:"檢視套件版本快訊，掌握套件更新。<br/>點擊 +  可新增套件至追蹤面板。",trigger:"hover"},{default:A(()=>[d(fe)]),_:1})])])],512)),f.value?(c(),v("div",je,[n("div",null,[d(me)])])):N("",!0),d(pe,{isOpen:y.value,class:"addDashboardModal"},{default:A(()=>[n("div",Me,[n("div",Re,[d(ke,{onClick:e[5]||(e[5]=t=>T(Ve)(o.value))}),d(ye,{onClick:q}),n("input",{ref_key:"fileInputRef",ref:O,type:"file",accept:".json",style:{display:"none"},onChange:K},null,544)]),n("div",Ee,[ie(n("textarea",{"onUpdate:modelValue":e[6]||(e[6]=t=>o.value=t),onBlur:e[7]||(e[7]=t=>o.value=T(we)(o.value))},null,544),[[re,o.value]])]),n("div",Ie,[n("div",{class:"cancel",onClick:e[8]||(e[8]=t=>y.value=!1)},"取消"),n("div",{class:"save",onClick:F},"儲存")])])]),_:1},8,["isOpen"])]))}});export{Ke as _};
